<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¢è·å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'game-primary': '#6D28D9',
                        'game-secondary': '#DB2777',
                        'game-dark': '#1A1625',
                        'game-light': '#E2E8F0',
                        'game-accent': '#F59E0B'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* åŸºç¤èƒŒæ™¯ */
        body {
            background: linear-gradient(125deg, #1a1c4b 0%, #372f6a 50%, #1a1c4b 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* æ¼¸å±¤æ¡†ç·šå¡ç‰‡ */
        .gradient-border-card {
            position: relative;
            background: rgba(13, 12, 19, 0.7);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(12px);
        }

        .gradient-border-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 1rem;
            padding: 2px;
            background: linear-gradient(
                45deg,
                #6D28D9,
                #DB2777,
                #6D28D9
            );
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        /* æ¼¸å±¤æ¡†ç·šæŒ‰éˆ• */
        .gradient-border-button {
            position: relative;
            background: rgba(13, 12, 19, 0.7);
            border-radius: 0.75rem;
            padding: 1rem;
            backdrop-filter: blur(12px);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .gradient-border-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0.75rem;
            padding: 2px;
            background: linear-gradient(
                45deg,
                #6D28D9,
                #DB2777,
                #6D28D9
            );
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        /* æ‡¸æµ®æ•ˆæœ */
        .gradient-border-button:hover {
            transform: translateY(-2px);
        }

        .gradient-border-button:hover::before {
            background: linear-gradient(
                45deg,
                #8B5CF6,
                #EC4899,
                #8B5CF6
            );
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes borderRotate {
            from { background-position: 0% center; }
            to { background-position: 200% center; }
        }

        .gradient-border-card::before,
        .gradient-border-button::before {
            background-size: 200% auto;
            animation: borderRotate 4s linear infinite;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-bar {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 9999px;
            overflow: hidden;
            height: 8px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6D28D9, #DB2777);
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        /* é–ƒå…‰æ•ˆæœ */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* æ›´æ–°çš„æ¨£å¼ */
        .modern-progress {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 999px;
            padding: 2px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .modern-progress-bar {
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg, #6D28D9, #DB2777);
            transition: width 0.3s ease;
            position: relative;
        }

        .stress-gradient {
            background: linear-gradient(90deg, #10B981, #F59E0B, #EF4444);
        }

        .title-badge {
            background: rgba(109, 40, 217, 0.2);
            border: 1px solid rgba(109, 40, 217, 0.3);
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.875rem;
            color: #A78BFA;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* æŒ‰éˆ•æ‡¸æµ®æ•ˆæœå„ªåŒ– */
        .gradient-border-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .gradient-border-button:active {
            transform: translateY(0);
        }

        /* å¡ç‰‡å‹•ç•«æ•ˆæœ */
        @keyframes cardFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .gradient-border-card {
            animation: cardFloat 4s ease-in-out infinite;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="font-['Noto_Sans_TC'] text-gray-100">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- ç­‰ç´šå¡ç‰‡ -->
            <div class="gradient-border-card p-6 relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
                    <i class="fas fa-crown text-yellow-400 animate-pulse"></i>
                    ç­‰ç´š
                </h2>
                <div class="flex flex-col items-center relative z-10">
                    <div class="text-4xl font-bold mb-2">
                        Lv.<span id="levelDisplay">1</span>
                    </div>
                    <div id="titleDisplay" class="title-badge mb-4">
                        è·å ´æ–°é®®äºº
                    </div>
                    <div class="w-full">
                        <div class="modern-progress">
                            <div id="expBar" class="modern-progress-bar"></div>
                        </div>
                        <div class="flex justify-between text-sm mt-2 text-gray-400">
                            <span><span id="expCurrent">0</span>/<span id="expTotal">100</span></span>
                            <span>ä¸‹ä¸€ç´šé‚„éœ€ <span id="expToNext">100</span> ç¶“é©—</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿ƒæƒ…çµ±è¨ˆå¡ç‰‡ -->
            <div class="gradient-border-card p-6">
                <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
                    <i class="fas fa-heart text-pink-400 animate-pulse"></i>
                    ä»Šæ—¥å¿ƒæƒ…
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-white/5 rounded-xl">
                        <div class="text-3xl mb-2">ğŸ˜Š</div>
                        <div class="text-sm text-gray-400">é–‹å¿ƒ</div>
                        <div id="happyCount" class="text-2xl font-bold text-green-400">0</div>
                    </div>
                    <div class="text-center p-4 bg-white/5 rounded-xl">
                        <div class="text-3xl mb-2">ğŸ˜¡</div>
                        <div class="text-sm text-gray-400">ç”Ÿæ°£</div>
                        <div id="angryCount" class="text-2xl font-bold text-red-400">0</div>
                    </div>
                </div>
            </div>

            <!-- å£“åŠ›æŒ‡æ•¸å¡ç‰‡ -->
            <div class="gradient-border-card p-6">
                <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
                    <i class="fas fa-gauge-high text-orange-400 animate-pulse"></i>
                    å£“åŠ›æŒ‡æ•¸
                </h2>
                <div class="text-center">
                    <div id="stressValue" class="text-4xl font-bold mb-4">0%</div>
                    <div class="modern-progress">
                        <div id="stressBar" class="modern-progress-bar stress-gradient"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŒ‰éˆ•å€åŸŸ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- å£“åŠ›æº -->
            <div class="space-y-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-bomb text-red-400"></i>
                    å£“åŠ›æº
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <!-- åŠ ç­æŒ‰éˆ• -->
                    <button id="overtimeBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">â°</div>
                            <div class="font-bold mb-1">åŠ ç­</div>
                            <div class="text-sm px-3 py-1 bg-red-500/20 rounded-full text-red-400">
                                +15 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>

                    <!-- æœƒè­°æŒ‰éˆ• -->
                    <button id="meetingBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">ğŸ‘¥</div>
                            <div class="font-bold mb-1">æœƒè­°</div>
                            <div class="text-sm px-3 py-1 bg-red-500/20 rounded-full text-red-400">
                                +10 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>

                    <!-- è¢«ç½µæŒ‰éˆ• -->
                    <button id="scoldedBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">ğŸ˜ </div>
                            <div class="font-bold mb-1">è¢«ç½µ</div>
                            <div class="text-sm px-3 py-1 bg-red-500/20 rounded-full text-red-400">
                                +20 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>

                    <!-- è¢«é›·æŒ‰éˆ• -->
                    <button id="troubleBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">âš¡</div>
                            <div class="font-bold mb-1">è¢«é›·</div>
                            <div class="text-sm px-3 py-1 bg-red-500/20 rounded-full text-red-400">
                                +12 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- æ¿€å‹µæº -->
            <div class="space-y-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-star text-yellow-400"></i>
                    æ¿€å‹µæº
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <!-- ç™¼è–ªæŒ‰éˆ• -->
                    <button id="salaryBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">ğŸ’°</div>
                            <div class="font-bold mb-1">ç™¼è–ª</div>
                            <div class="text-sm px-3 py-1 bg-green-500/20 rounded-full text-green-400">
                                -30 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>

                    <!-- çé‡‘æŒ‰éˆ• -->
                    <button id="bonusBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">ğŸ</div>
                            <div class="font-bold mb-1">çé‡‘</div>
                            <div class="text-sm px-3 py-1 bg-green-500/20 rounded-full text-green-400">
                                -25 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>

                    <!-- å‡è·æŒ‰éˆ• -->
                    <button id="promotionBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">â­</div>
                            <div class="font-bold mb-1">å‡è·</div>
                            <div class="text-sm px-3 py-1 bg-green-500/20 rounded-full text-green-400">
                                -40 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>

                    <!-- ä¼‘å‡æŒ‰éˆ• -->
                    <button id="vacationBtn" class="gradient-border-button group">
                        <div class="relative z-10 flex flex-col items-center">
                            <div class="text-3xl mb-2 group-hover:animate-bounce">âœˆï¸</div>
                            <div class="font-bold mb-1">ä¼‘å‡</div>
                            <div class="text-sm px-3 py-1 bg-green-500/20 rounded-full text-green-400">
                                -35 å£“åŠ›å€¼
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- åˆ†äº«æŒ‰éˆ• -->
        <div class="text-center mt-8">
            <button id="shareBtn" class="gradient-border-button inline-flex items-center gap-2 px-8 py-4 text-lg">
                <i class="fas fa-share-alt"></i>
                åˆ†äº«é€²åº¦
            </button>
        </div>
    </div>

    <script>
    // å…¨å±€ç‹€æ…‹
    let state = null;

    // åˆå§‹åŒ–ç‹€æ…‹
    function initializeState() {
        try {
            const savedState = localStorage.getItem('quitJobState');
            if (savedState) {
                state = JSON.parse(savedState);
            } else {
                state = {
                    level: 1,
                    exp: 0,
                    expToNextLevel: 100,
                    stress: 0,
                    dailyStats: {
                        happy: 0,
                        angry: 0
                    }
                };
            }
            console.log('åˆå§‹åŒ–ç‹€æ…‹æˆåŠŸ:', state);
        } catch (error) {
            console.error('åˆå§‹åŒ–ç‹€æ…‹å¤±æ•—:', error);
        }
    }

    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    function bindButtons() {
        // å£“åŠ›æºæŒ‰éˆ•
        document.getElementById('overtimeBtn')?.addEventListener('click', () => handleStressButton(15, 'åŠ ç­'));
        document.getElementById('meetingBtn')?.addEventListener('click', () => handleStressButton(10, 'æœƒè­°'));
        document.getElementById('scoldedBtn')?.addEventListener('click', () => handleStressButton(20, 'è¢«ç½µ'));
        document.getElementById('troubleBtn')?.addEventListener('click', () => handleStressButton(12, 'è¢«é›·'));

        // æ¿€å‹µæºæŒ‰éˆ•
        document.getElementById('salaryBtn')?.addEventListener('click', () => handleEncourageButton(30, 'ç™¼è–ª'));
        document.getElementById('bonusBtn')?.addEventListener('click', () => handleEncourageButton(25, 'çé‡‘'));
        document.getElementById('promotionBtn')?.addEventListener('click', () => handleEncourageButton(40, 'å‡è·'));
        document.getElementById('vacationBtn')?.addEventListener('click', () => handleEncourageButton(35, 'ä¼‘å‡'));

        // åˆ†äº«æŒ‰éˆ•
        document.getElementById('shareBtn')?.addEventListener('click', handleShare);
    }

    // è™•ç†å£“åŠ›æŒ‰éˆ•é»æ“Š
    function handleStressButton(value, action) {
        if (!state) return;
        
        // æ›´æ–°å¿ƒæƒ…çµ±è¨ˆ
        state.dailyStats.angry++;
        
        // å¢åŠ ç¶“é©—å€¼
        addExperience(value);
        
        // å¢åŠ å£“åŠ›
        state.stress = Math.min(100, state.stress + value);
        
        // æ›´æ–° UI
        updateUI();
        
        // é¡¯ç¤ºæç¤º
        showToast(`${action}ï¼+${value} ç¶“é©—å€¼ï¼Œ+${value} å£“åŠ›å€¼`);
        
        // ä¿å­˜ç‹€æ…‹
        saveState();
    }

    // è™•ç†æ¿€å‹µæŒ‰éˆ•é»æ“Š
    function handleEncourageButton(value, action) {
        if (!state) return;
        
        // æ›´æ–°å¿ƒæƒ…çµ±è¨ˆ
        state.dailyStats.happy++;
        
        // å¢åŠ ç¶“é©—å€¼
        addExperience(value);
        
        // æ¸›å°‘å£“åŠ›
        state.stress = Math.max(0, state.stress - value);
        
        // æ›´æ–° UI
        updateUI();
        
        // é¡¯ç¤ºæç¤º
        showToast(`${action}ï¼+${value} ç¶“é©—å€¼ï¼Œ-${value} å£“åŠ›å€¼`);
        
        // ä¿å­˜ç‹€æ…‹
        saveState();
    }

    // æ·»åŠ ç¶“é©—å€¼
    function addExperience(exp) {
        if (!state) return;
        
        const oldTitle = getCurrentTitle(state.level);
        state.exp += exp;
        
        // æª¢æŸ¥å‡ç´š
        while (state.exp >= state.expToNextLevel) {
            state.level += 1;
            state.exp -= state.expToNextLevel;
            state.expToNextLevel = Math.floor(state.expToNextLevel * 1.2);
            
            const newTitle = getCurrentTitle(state.level);
            
            // å‡ç´šæç¤º
            Swal.fire({
                title: 'ç­‰ç´šæå‡ï¼',
                html: `
                    æ­å–œä½ å‡åˆ° ${state.level} ç´šï¼<br>
                    ${oldTitle.name !== newTitle.name ? `<div class="mt-2">ç²å¾—æ–°ç¨±è™Ÿï¼š<span class="text-yellow-400">${newTitle.name}</span></div>` : ''}
                `,
                icon: 'success',
                background: '#1A1625',
                color: '#FFFFFF',
                confirmButtonColor: '#6D28D9'
            });
        }
    }

    // æ›´æ–° UI
    function updateUI() {
        if (!state) return;
        
        // æ›´æ–°ç­‰ç´šå’Œç¨±è™Ÿ
        const levelDisplay = document.getElementById('levelDisplay');
        const titleDisplay = document.getElementById('titleDisplay');
        if (levelDisplay) {
            levelDisplay.textContent = state.level;
        }
        if (titleDisplay) {
            const currentTitle = getCurrentTitle(state.level);
            titleDisplay.textContent = currentTitle.name;
            
            // æ ¹æ“šç¨±è™Ÿç­‰ç´šè¨­ç½®ä¸åŒçš„é¡è‰²
            const colors = {
                1: 'text-gray-400 bg-gray-500/20',
                5: 'text-blue-400 bg-blue-500/20',
                10: 'text-green-400 bg-green-500/20',
                15: 'text-yellow-400 bg-yellow-500/20',
                20: 'text-orange-400 bg-orange-500/20',
                25: 'text-red-400 bg-red-500/20',
                30: 'text-purple-400 bg-purple-500/20',
                35: 'text-pink-400 bg-pink-500/20',
                40: 'text-indigo-400 bg-indigo-500/20',
                45: 'text-cyan-400 bg-cyan-500/20',
                50: 'text-amber-400 bg-amber-500/20'
            };
            
            titleDisplay.className = `text-sm px-3 py-1 rounded-full ${colors[currentTitle.level] || colors[1]}`;
        }
        
        // æ›´æ–°ç¶“é©—å€¼
        const expPercentage = (state.exp / state.expToNextLevel) * 100;
        document.getElementById('expBar').style.width = `${expPercentage}%`;
        document.getElementById('expCurrent').textContent = state.exp;
        document.getElementById('expTotal').textContent = state.expToNextLevel;
        document.getElementById('expToNext').textContent = state.expToNextLevel - state.exp;
        
        // æ›´æ–°å¿ƒæƒ…çµ±è¨ˆ
        document.getElementById('happyCount').textContent = state.dailyStats.happy;
        document.getElementById('angryCount').textContent = state.dailyStats.angry;
        
        // æ›´æ–°å£“åŠ›å€¼
        document.getElementById('stressBar').style.width = `${state.stress}%`;
        document.getElementById('stressValue').textContent = `${state.stress}%`;
    }

    // é¡¯ç¤ºæç¤º
    function showToast(message) {
        Swal.fire({
            text: message,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            background: '#1A1625',
            color: '#FFFFFF'
        });
    }

    // ä¿å­˜ç‹€æ…‹
    function saveState() {
        if (state) {
            localStorage.setItem('quitJobState', JSON.stringify(state));
        }
    }

    // è™•ç†åˆ†äº«åŠŸèƒ½
    async function handleShare() {
        try {
            // è©¢å•æš±ç¨±ï¼Œè¨­å®šé è¨­å€¼ç‚ºã€ŒåŒ¿åç¤¾ç•œã€
            const { value: nickname, isDismissed } = await Swal.fire({
                title: 'åˆ†äº«ä½ çš„é›¢è·é€²åº¦',
                input: 'text',
                inputLabel: 'ä½ çš„æš±ç¨±',
                inputValue: 'åŒ¿åç¤¾ç•œ', // é è¨­å€¼
                inputPlaceholder: 'è«‹è¼¸å…¥æš±ç¨±',
                inputAttributes: {
                    maxlength: '20'
                },
                background: '#1A1625',
                color: '#FFFFFF',
                confirmButtonColor: '#6D28D9',
                showCancelButton: true,
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonText: 'ç”Ÿæˆåœ–ç‰‡',
                // ç§»é™¤é©—è­‰ï¼Œå…è¨±ä½¿ç”¨é è¨­æš±ç¨±
                showClass: {
                    popup: 'animate__animated animate__fadeIn animate__faster'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOut animate__faster'
                }
            });

            // ç”¨æˆ¶é»æ“Šå–æ¶ˆ
            if (isDismissed) return;

            // ä½¿ç”¨è¼¸å…¥çš„æš±ç¨±æˆ–é è¨­å€¼
            const finalNickname = nickname || 'åŒ¿åç¤¾ç•œ';

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            Swal.fire({
                title: 'ç”Ÿæˆåˆ†äº«åœ–ç‰‡ä¸­...',
                text: 'è«‹ç¨å€™',
                allowOutsideClick: false,
                showConfirmButton: false,
                background: '#1A1625',
                color: '#FFFFFF',
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            const imageUrl = await generateShareCard(finalNickname);

            // é¡¯ç¤ºé è¦½
            Swal.fire({
                title: 'åˆ†äº«é è¦½',
                imageUrl: imageUrl,
                imageWidth: 600,
                imageAlt: 'é›¢è·é€²åº¦åˆ†äº«',
                background: '#1A1625',
                color: '#FFFFFF',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'ä¸‹è¼‰åœ–ç‰‡',
                denyButtonText: 'è¤‡è£½åœ–ç‰‡',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#6D28D9',
                denyButtonColor: '#DB2777',
                cancelButtonColor: '#4B5563'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // ä¸‹è¼‰åœ–ç‰‡
                    const link = document.createElement('a');
                    link.download = `é›¢è·é€²åº¦_${finalNickname}_${new Date().toLocaleDateString()}.png`;
                    link.href = imageUrl;
                    link.click();
                    
                    // é¡¯ç¤ºä¸‹è¼‰æˆåŠŸæç¤º
                    Swal.fire({
                        title: 'ä¸‹è¼‰æˆåŠŸï¼',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false,
                        background: '#1A1625',
                        color: '#FFFFFF'
                    });
                } else if (result.isDenied) {
                    // è¤‡è£½åœ–ç‰‡åˆ°å‰ªè²¼ç°¿
                    try {
                        const blob = await (await fetch(imageUrl)).blob();
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        Swal.fire({
                            title: 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false,
                            background: '#1A1625',
                            color: '#FFFFFF'
                        });
                    } catch (error) {
                        console.error('è¤‡è£½åœ–ç‰‡å¤±æ•—:', error);
                        Swal.fire({
                            title: 'è¤‡è£½å¤±æ•—',
                            text: 'è«‹ä½¿ç”¨ä¸‹è¼‰åŠŸèƒ½',
                            icon: 'error',
                            background: '#1A1625',
                            color: '#FFFFFF'
                        });
                    }
                }
            });

        } catch (error) {
            console.error('åˆ†äº«å¤±æ•—:', error);
            Swal.fire({
                title: 'åˆ†äº«å¤±æ•—',
                text: 'ç”Ÿæˆåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤',
                icon: 'error',
                background: '#1A1625',
                color: '#FFFFFF'
            });
        }
    }

    async function generateShareCard(nickname) {
        const canvas = document.createElement('canvas');
        canvas.width = 1200;
        canvas.height = 630;
        const ctx = canvas.getContext('2d');

        // ç¹ªè£½æ¼¸å±¤èƒŒæ™¯
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#6D28D9');
        gradient.addColorStop(1, '#DB2777');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // æ·»åŠ è£é£¾æ•ˆæœ
        ctx.beginPath();
        ctx.arc(0, 0, 400, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.fill();

        ctx.beginPath();
        ctx.arc(canvas.width, canvas.height, 300, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.fill();

        // ç¹ªè£½æ¨™é¡Œå’Œæš±ç¨±
        ctx.textAlign = 'center';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.font = 'bold 48px "Noto Sans TC"';
        ctx.fillText(`${nickname} çš„é›¢è·é€²åº¦`, canvas.width / 2, 80);

        // ç¹ªè£½ç­‰ç´šå’Œç¨±è™Ÿ
        const currentTitle = getCurrentTitle(state.level);
        ctx.font = 'bold 36px "Noto Sans TC"';
        ctx.fillText(`Lv.${state.level} Â· ${currentTitle.name}`, canvas.width / 2, 140);

        // ç¹ªè£½ç¶“é©—å€¼é€²åº¦æ¢
        const drawProgressBar = (x, y, width, height, progress, color1, color2, label) => {
            // é€²åº¦æ¢èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.roundRect(x, y, width, height, height/2);
            ctx.fill();

            // é€²åº¦æ¢å¡«å……
            const barGradient = ctx.createLinearGradient(x, 0, x + width, 0);
            barGradient.addColorStop(0, color1);
            barGradient.addColorStop(1, color2);
            ctx.fillStyle = barGradient;
            ctx.roundRect(x, y, width * progress, height, height/2);
            ctx.fill();

            // é€²åº¦æ¢æ¨™ç±¤
            ctx.font = '24px "Noto Sans TC"';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.textAlign = 'left';
            ctx.fillText(label, x, y - 10);
        };

        // ç¹ªè£½å„ç¨®é€²åº¦æ¢
        const barWidth = 800;
        const barHeight = 20;
        let currentY = 200;
        const barSpacing = 80;

        // ç¶“é©—å€¼é€²åº¦æ¢
        const expProgress = state.exp / state.expToNextLevel;
        drawProgressBar(
            (canvas.width - barWidth) / 2,
            currentY,
            barWidth,
            barHeight,
            expProgress,
            '#F59E0B',
            '#DB2777',
            `ç¶“é©—å€¼ï¼š${state.exp}/${state.expToNextLevel}`
        );
        currentY += barSpacing;

        // å£“åŠ›æŒ‡æ•¸é€²åº¦æ¢
        const stressProgress = state.stress / 100;
        drawProgressBar(
            (canvas.width - barWidth) / 2,
            currentY,
            barWidth,
            barHeight,
            stressProgress,
            '#10B981',
            '#EF4444',
            `å£“åŠ›æŒ‡æ•¸ï¼š${state.stress}%`
        );
        currentY += barSpacing;

        // å¿ƒæƒ…çµ±è¨ˆ
        ctx.textAlign = 'center';
        ctx.font = '32px "Noto Sans TC"';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.fillText(
            `ä»Šæ—¥å¿ƒæƒ…çµ±è¨ˆï¼šğŸ˜Š ${state.dailyStats.happy} | ğŸ˜¡ ${state.dailyStats.angry}`,
            canvas.width / 2,
            currentY + 20
        );
        currentY += barSpacing;

        // æ·»åŠ æˆå°±æˆ–å…¶ä»–çµ±è¨ˆ
        if (state.achievements) {
            ctx.fillText(
                `è§£é–æˆå°±ï¼š${state.achievements} å€‹`,
                canvas.width / 2,
                currentY + 20
            );
        }

        // æ·»åŠ æ™‚é–“æˆ³è¨˜
        ctx.font = '24px "Noto Sans TC"';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        const date = new Date().toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        ctx.fillText(date, canvas.width / 2, canvas.height - 80);

        // æ·»åŠ  QR Code
        const qr = await new Promise((resolve) => {
            QRCode.toCanvas(
                document.createElement('canvas'),
                window.location.href,
                {
                    width: 150,
                    margin: 0,
                    color: {
                        dark: '#FFFFFF',
                        light: '#00000000'
                    }
                },
                (error, canvas) => resolve(canvas)
            );
        });

        // ç¹ªè£½ QR Code èƒŒæ™¯
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.roundRect(
            canvas.width - 200,
            canvas.height - 200,
            150,
            150,
            10
        );
        ctx.fill();

        // ç¹ªè£½ QR Code
        ctx.drawImage(
            qr,
            canvas.width - 200,
            canvas.height - 200,
            150,
            150
        );

        // æ·»åŠ æƒææç¤ºæ–‡å­—
        ctx.font = '16px "Noto Sans TC"';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.fillText(
            'æƒæ QR Code é–‹å§‹ä½ çš„é›¢è·ä¹‹æ—…',
            canvas.width - 125,
            canvas.height - 20
        );

        return canvas.toDataURL('image/png');
    }

    // æ·»åŠ ç¨±è™Ÿç³»çµ±
    const TITLES = [
        { level: 1, name: 'è·å ´æ–°é®®äºº' },
        { level: 5, name: 'åˆå¿ƒç¤¾ç•œ' },
        { level: 10, name: 'è³‡æ·±ç¤¾ç•œ' },
        { level: 15, name: 'å­ä¸–å¤§å¸«' },
        { level: 20, name: 'é›¢è·é å‚™è»' },
        { level: 25, name: 'è·å ´é”äºº' },
        { level: 30, name: 'é›¢è·å¤§å¸«' },
        { level: 35, name: 'è·å ´ä¹‹ç¥' },
        { level: 40, name: 'è‡ªç”±ä¹‹é­‚' },
        { level: 45, name: 'äººç”Ÿå‹åˆ©çµ„' },
        { level: 50, name: 'è²¡å¯Œè‡ªç”±äºº' }
    ];

    // ç²å–ç•¶å‰ç­‰ç´šå°æ‡‰çš„ç¨±è™Ÿ
    function getCurrentTitle(level) {
        return TITLES.reduce((current, title) => {
            if (level >= title.level && title.level >= current.level) {
                return title;
            }
            return current;
        }, TITLES[0]);
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        initializeState();
        bindButtons();
        updateUI();
    });
    </script>
</body>

</html>